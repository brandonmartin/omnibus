--- ./tilde.c.orig	2012-03-22 17:33:17.000000000 -0700
+++ ./tilde.c	2012-03-22 17:58:29.000000000 -0700
@@ -18,6 +18,7 @@
    You should have received a copy of the GNU General Public License
    along with Readline; see the file COPYING.  If not, write to the Free
    Software Foundation, 59 Temple Place, Suite 330, Boston, MA 02111 USA. */
+#define READLINE_LIBRARY
 
 #if defined (HAVE_CONFIG_H)
 #  include <config.h>
@@ -47,6 +48,10 @@
 #include <pwd.h>
 #endif
 
+#if defined (_WIN32)
+#include <windows.h>
+#endif
+
 #include "tilde.h"
 
 #if defined (TEST) || defined (STATIC_MALLOC)
@@ -345,7 +350,12 @@
 {
   char *dirname, *expansion, *username;
   int user_len;
+#if !defined (_WIN32)
   struct passwd *user_entry;
+#else /* _WIN32 */
+  char UserName[256];
+  unsigned long UserLen = 256;
+#endif /* _WIN32 */
 
   if (filename == 0)
     return ((char *)NULL);
@@ -386,6 +396,7 @@
   /* No preexpansion hook, or the preexpansion hook failed.  Look in the
      password database. */
   dirname = (char *)NULL;
+#if !defined (_WIN32)
 #if defined (HAVE_GETPWNAM)
   user_entry = getpwnam (username);
 #else
@@ -418,6 +429,16 @@
 #if defined (HAVE_GETPWENT)
   endpwent ();
 #endif
+#else /* _WIN32 */
+  if (GetUserName (UserName, &UserLen))
+    {
+      if (!stricmp (username, UserName))
+	dirname = glue_prefix_and_suffix (sh_get_home_dir (), filename, user_len);
+      else if (dirname == 0)
+	dirname = savestring (filename);
+    }
+  free (username);
+#endif /* _WIN32 */
   return (dirname);
 }
 
